@page "/Book/{BookId:int}"
@implements IDisposable
@using BymseRead.Ui.Models
@using BymseRead.Ui.Pages.Book.Bookmarks
@using BymseRead.Core.Models
@using BymseRead.Core
@using BymseRead.DataLayer.Entity
@using BymseRead.DataLayer.Helpers
@using BymseRead.Ui.Abstractions
@using BookForm = BymseRead.Core.Models.BookFormModel
@inject BooksService BooksService
@inject IJSRuntime JsRuntime
@inject NavigationManager NavigationManager

<div class="book-page-container">
    <div class="control-panel">
        <div class="control-panel__left">
            <button class="control-panel__bookmarks-list-btn" type="button" @onclick="ToggleBookmarks"></button>
            <div class="control-panel__title" title="@Title">@Title</div>
        </div>
        <div class="control-panel__center">
            @if (BookModel.TotalPages.HasValue)
            {
                <div class="control-panel__pages">
                    <PagesInput
                        TotalPages="@BookModel.TotalPages.Value"
                        InitialCurrentPage="initialCurrentPage"
                        BookPagesFacade="bookPdfViewerFacade"/>
                </div>
            }
        </div>
        <div class="control-panel__right">
            <div class="control-panel__tags" title="@BookModel.TagsWithHashes.JoinStrings(" ")">
                @foreach (var tag in BookModel.TagsWithHashes)
                {
                    <span>@tag</span>
                }
            </div>
            @* <button class="control-panel__bookmarks-btn control-panel__bookmarks-btn_add"></button> *@
            <button type="button" class="control-panel__edit" onclick="@OnEditClick"></button>
            <DeleteButton Book="BookModel"/>
        </div>
    </div>
    <div class="book-content" id="book-content">
        <Bookmarks BookModel="BookModel" Show="OpenBookmarks" BookPagesFacade="bookPdfViewerFacade"/>
        <div class="book-wrapper">
            <PdfViewer @ref="bookPdfViewerFacade.PdfViewerRef" InitialCurrentPage="initialCurrentPage" BookUrl="@BookModel.Url"></PdfViewer>
        </div>
        @* <div class="side-buttons"> *@
        @*     <button type="button" class="@(IsFullscreen ? "side-buttons__full-size_full" : "side-buttons__full-size")" @onclick="ToggleFullscreen"></button> *@
        @* </div> *@
    </div>
</div>
@if (OpenEditForm)
{
    <BookForm FormTitle="Edit book" Model="@BookModel" @bind-Show="OpenEditForm" OnSubmit="@OnFormSubmit"/>
}

@code {

    [Parameter]
    public int BookId { get; set; }

    [CascadingParameter]
    public MainLayout MainLayout { get; set; }

    private BookModel BookModel { get; set; }


    private string Title => $"{BookModel.Title} by {BookModel.Author}";
    private int initialCurrentPage;

    private bool OpenEditForm { get; set; }
    private bool OpenBookmarks { get; set; } = true;
    private bool IsFullscreen { get; set; }

    private void OnClose() => OpenEditForm = false;

    private readonly BookPdfViewerFacade bookPdfViewerFacade = new();
    private ITopBarItem? topBarItem;


    protected override async Task OnInitializedAsync()
    {
        topBarItem = new LinkTopBarItem
        {
            Url = "/",
            Css = "top-bar__back-button"
        };
        MainLayout.Items.Add(topBarItem);

        BookModel = BooksService.FindBook(BookId)!;
        initialCurrentPage = BookModel.LastViewedPage ?? 1;

        bookPdfViewerFacade.ViewerInitialized += OnBookPdfViewerFacadeInitialized;
    }

    private void OnEditClick()
    {
        OpenEditForm = true;
    }

    private void ToggleBookmarks() => OpenBookmarks = !OpenBookmarks;

    private async Task OnFormSubmit()
    {
        BookModel = BooksService.SaveBook(BookModel);
        OpenEditForm = false;
        StateHasChanged();
        await Task.Delay(1);
    //await InitializePdfViewerAsync();
    }

    private Task OnBookPdfViewerFacadeInitialized(object sender, ViewerInitializedEventArgs e)
    {
        BooksService.UpdateTotalPages(BookId, e.TotalPages);
        BookModel.TotalPages = e.TotalPages;
        return Task.CompletedTask;
    }

    private async Task ToggleFullscreen()
    {
        IsFullscreen = !IsFullscreen;
        if (IsFullscreen)
        {
            await JsRuntime.InvokeVoidAsync("openFullscreen", "#book-content");
        }
        else
        {
            await JsRuntime.InvokeVoidAsync("exitFullscreen");
        }
    }

    public void Dispose()
    {
        if (topBarItem != null)
        {
            MainLayout.Items.Remove(topBarItem);
        }
        bookPdfViewerFacade.Dispose();
    }

}